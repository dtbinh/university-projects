<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
<TITLE>RATE CONTROL AND QUANTIZATION CONTROL</TITLE>
</HEAD>
<BODY bgcolor=#FFFFFF>
<H1>10 RATE CONTROL AND QUANTIZATION CONTROL<BR>
</H1>
<P>
This section describes the procedure for controlling the bit-rate of
the Test Model by adapting the macroblock quantization parameter
<i><b>quantizer_scale</i></b>.  The algorithm works in three-steps:<BR>
<P>
<B>1 Target bit allocation</B>:
this step estimates the number of bits available to code the next
picture.  It is performed before coding the picture.<BR>
<P>
<B>2 Rate control</B>:  by means
of a &quot;virtual buffer&quot;, this step sets the reference
value of the quantization parameter for each macroblock.<BR>
<P>
<B>3 Adaptive quantization</B>:
 this step modulates the reference value of the quantization parameter
according to the spatial activity in the macroblock to derive
the value of the quantization parameter, mquant, that is used
to quantize the macroblock.<BR>


<H2>Step 1 - Bit Allocation</H2>
<H3>Complexity estimation<BR>
</H3>
<P>
 After a picture of a certain type (I, P, or B) is
encoded, the respective &quot;global complexity measure&quot;
(Xi, Xp, or Xb) is updated as: 
<P>
<CENTER><IMG SRC="IMG00001.GIF"></CENTER>
<P>
 where Si, Sp, Sb are the number of bits generated
by encoding this picture and Qi, Qp and Qb are the average quantization
parameter computed by averaging the actual quantization values
used during the encoding of the all the macroblocks, including
the skipped macroblocks.<BR>
 
<P>
 Initial values 
<P>
   Xi = (160 * <B>bit_rate</B>) / 115 
<P>
   Xp = (60 * <B>bit_rate)</B> / 115 
<P>
   Xb = (42 * <B>bit_rate</B>) / 115<BR>
 
<P>
<B> bit_rate </B>  is measured in
bits/s.<BR>
 
<H3>Picture Target Setting</H3>
<P>
 The target number of bits for the next picture in
the Group of pictures (Ti, Tp, or Tb) is computed as: 
<P>
<IMG SRC="IMG00002.GIF"><BR>
<BR>
<BR>
<P>
<IMG SRC="IMG00003.GIF"><BR>
<BR>
<BR>
<P>
<IMG SRC="IMG00004.GIF"><BR>
<BR>
<P>
 Where: 
<P>
 Kp and Kb are &quot;universal&quot; constants dependent
on the quantization matrices.  For the matrices specified in sections
7.1 and 7.2   Kp = 1.0 and Kb = 1.4.<BR>
 
<P>
 R is the remaining number of bits assigned to the
GROUP OF PICTURES.  R is updated as follows:<BR>
 
<P>
  After encoding a picture , R = R - Si,p,b<BR>
 
<P>
 Where is Si,p,b  is the number of bits generated
in the picture just encoded (picture type is I, P or B).<BR>
 
<P>
 Before encoding the first picture in a GROUP OF PICTURES
(an I-picture):<BR>
 
<P>
  R = G + R 
<P>
  G = <B>bit_rate</B> * N / <B>picture_rate</B> 
<P>
  N is the number of pictures in the GROUP OF PICTURES.
<BR>
 
<P>
 At the start of the sequence R = 0.<BR>
 
<P>
 Np and Nb are the number of P-pictures and B-pictures
remaining in the current GROUP OF PICTURES in the encoding order.
<BR>

<CENTER>
<TABLE BORDER=1>
<TR><TD ><CENTER> I </CENTER></TD><TD><CENTER>B</CENTER>
</TD><TD><CENTER>B</CENTER></TD><TD><CENTER>P</CENTER>
</TD><TD><CENTER>B</CENTER></TD><TD><CENTER>B</CENTER>
</TD><TD><CENTER>P</CENTER></TD><TD><CENTER>B</CENTER>
</TD><TD><CENTER>B</CENTER></TD><TD><CENTER>P</CENTER>
</TD><TD><CENTER>B</CENTER></TD><TD><CENTER>B</CENTER>
</TD><TD><CENTER>P</CENTER></TD></TR>
<TR><TD COLSPAN=6></td><td>R-bits</TD></TR>
<TR><TD COLSPAN=6></td><td>Np = 3</TD><TD></TD><TD>
<TR><TD COLSPAN=6></td><td>Nb = 4</TD></TR>
</TABLE>
</CENTER>

<P>
<CENTER><B>Figure 10.1 - Example of Remaining pictures in GOP at frame 7</B></CENTER>
<H2>Step 2 - Rate Control<BR>
</H2>
<P>
<CENTER><IMG SRC="IMG00005.GIF"><BR>
</CENTER>
<P>
<CENTER><B> Figure 10.2 : Rate Control for P-pictures
<BR>
 </B></CENTER>
<P>
 Before encoding macroblock j (j &gt;= 1), compute
the fullness of the appropriate virtual buffer:<BR>
 
<P>
<CENTER><IMG SRC="IMG00006.GIF"></CENTER>
<P>
 or 
<P>
<CENTER><IMG SRC="IMG00007.GIF"></CENTER>
<P>
 or 
<P>
<CENTER><IMG SRC="IMG00008.GIF"></CENTER>
<P>
 &#133;depending on the picture type.<BR>
 
<P>
 where 
<P>
  <IMG SRC="IMG00009.GIF">are initial fullnesses of
virtual buffers - one for each picture type.<BR>
 
<P>
  Bj is the number of bits generated by encoding all
macroblocks in the picture up to and including j.<BR>
 
<P>
  MB_cnt is the number of macroblocks in the picture.
<BR>
 
<P>
  <IMG SRC="IMG00010.GIF"> are the fullnesses of virtual
buffers at macroblock j- one for each picture type.<BR>
 
<P>
 The final fullness of the virtual buffer (<IMG SRC="IMG00011.GIF">:
j = MB_cnt) is used as <IMG SRC="IMG00012.GIF"> for encoding the
next picture of the same type.<BR>
 
<P>
 Next compute the reference quantization parameter
Qj for macroblock j as follows: 
<P>
<CENTER><IMG SRC="IMG00013.GIF"></CENTER>
<P>
 where the &quot;reaction parameter&quot; r is given
by  
<P>
<CENTER><IMG SRC="IMG00014.GIF"><BR>
</CENTER>
<P>
 and dj is the fullness of the appropriate virtual
buffer.<BR>
 
<P>
 The initial value for the virtual buffer fullness
is: 
<P>
<CENTER><IMG SRC="IMG00015.GIF"></CENTER>
<H2>Step 3 - Adaptive Quantization<BR>
</H2>
<P>
 Compute a spatial activity measure for the macroblock
j from the four luminance frame-organised sub-blocks (n=1..4)
<U>and</U> the four luminance field-organised sub-blocks (n=5..8)
using the intra (i.e. original) pixel values:<BR>
 
<P>
<CENTER><IMG SRC="IMG00016.GIF"></CENTER>
<P>
 where 
<P>
<CENTER><IMG SRC="IMG00017.GIF"></CENTER>
<P>
 and 
<P>
<CENTER><IMG SRC="IMG00018.GIF"><BR>
</CENTER>
<P>
 and Pk are the sample values in the n-th original
8*8 block.<BR>
 
<P>
 Normalise actj:<BR>
 
<P>
<CENTER><IMG SRC="IMG00019.GIF"><BR>
</CENTER>
<P>
 avg_act is the average value of  actj the last picture
to be encoded.  On the first picture, avg_act = 400.<BR>
 
<P>
 Obtain mquantj as: 
<P>
<CENTER><IMG SRC="IMG00020.GIF"></CENTER>
<P>
 where Qj is the reference quantization parameter
obtained in step 2.  The final value of mquantj is clipped to
the range [1..31] and is used and coded as described in sections
7, 8 and 9 in either the slice or macroblock layer.<BR>
 
<H2>Known Limitations<BR>
</H2>
<UL>
<LI> Step 1 does not handle scene changes efficiently. 
<LI> A wrong value of avg_act is used in step 3 after
a scene change. 
<LI> VBV compliance is not guaranteed. 
</UL>
<P>
<HR>
<P><LI><A HREF="../index.html">Back</A> to Contents</P>
</BODY>
</HTML>
